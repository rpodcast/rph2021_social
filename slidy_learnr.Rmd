---
title: "slidy learnr"
output: slidy_presentation
runtime: shiny_prerendered
description: >
  This is a demo of a learnr tutorial in slidy format
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(learnr)
library(dygraphs)
library(dplyr)
library(purrr)

question2 <- purrr::lift_dl(question)

qbank <- list(
  q1 = list(
    text = "What number is the letter A in the English alphabet?",
    type = "learnr_radio",
    answers = list(
      list(
        text = "8",
        correct = FALSE
      ),
      list(
        text = "14",
        correct = FALSE
      ),
      list(
        text = "1",
        correct = TRUE
      ),
      list(
        text = "23",
        correct = FALSE
      )
    )
  ),
  q2 = list(
    text = "Who is the best?",
    type = "learnr_radio",
    answers = list(
      list(
        text = "Jericho",
        correct = TRUE
      ),
      list(
        text = "Nia",
        correct = FALSE
      )
    )
  )
)

# assumes x is a list pertaining to the invidual question
# this function does not work when put into a chunk
# so I guess I need to make this like a child rmarkdown fragment
gen_question <- function(x, type = "leanr_radio") {
  df <- tibble::tibble(
    f = rep("answer", length(x[["answers"]])),
    params = x[["answers"]]
  )

  #tmp <- invoke_map(df$f, df$params)
  question2(invoke_map(df$f, df$params), text = x[["text"]], type = type)
}


gen_question_rmd <- function(x, label, type = "learnr_radio") {
  withr::local_options(list(htmltools.preserve.raw = FALSE))
  label <- label
  tmp <- markdown(knitr::knit_child(
    text = c(
glue::glue('```{r <<label>>, echo=FALSE}', label = label, .open="<<", .close=">>"),
'question2 <- lift_dl(question)',
'',
'df <- tibble::tibble(f = rep("answer", length(x[["answers"]])), params = x[["answers"]])',
'',
'tmp <- invoke_map(df$f, df$params)',
'',
'question2(tmp, text = x[["text"]], type = type)',
'',
'```',
''
    ), envir = environment(), quiet = TRUE))
  return(tmp)
}

out <- purrr::map_chr(seq_along(qbank), ~{
  glue::glue("\n\n## Question <<i>>\n\n```{r q-<<i>>, echo=FALSE}\nHTML(gen_question_rmd(qbank[[<<i>>]], label='qq<<i>>'))\n```\n\n",
             i = .x,
             .open = "<<",
             .close = ">>")
})

render_child <- function(text) {
  tmp <- tempfile(fileext = ".md")
  xfun::write_utf8(knitr::knit_child(text=text, quiet = TRUE), tmp)
  res <- rmarkdown::render(tmp, 'html_fragment', quiet = TRUE) # should we add `envir = knitr::knit_global()` ?
  xfun::read_utf8(res)
}
```

```{r create-slides22, eval = TRUE, results='asis'}
out <- purrr::map_chr(seq_along(qbank), ~{
  knitr::knit_child(text = glue::glue("\n\n## Question <<i>>\n\n```{r q-<<i>>, echo=FALSE}\nHTML(gen_question_rmd(qbank[[<<i>>]], label='qq<<i>>'))\n```\n\n",
             i = .x,
             .open = "<<",
             .close = ">>"), quiet = TRUE)
})
cat(unlist(out), sep = '\n')
```

